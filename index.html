<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8' />
    <title>Alexander Danilenko</title>
    <link rel="stylesheet" type="text/css" href="/stylesheets/application.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/bootstrap-responsive.css" media="screen" />
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js'></script>
    <script src='/javascripts/bootstrap-collapse.js'></script>
    <meta content='nanoc 3.4.0' name='generator' />
    <meta content='width=device-width, initial-scale=1.0' name='viewport' />
    <link href='http://danilenko.org/feed.xml' rel='alternate' title='Danilenko.org' type='application/rss+xml' />
    <script type="text/javascript">
    
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-33217982-1']);
      _gaq.push(['_trackPageview']);
    
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    
    </script>
  </head>
  <body>
    <div class='navbar'>
      <div class='navbar-inner'>
        <div class='container-fluid'>
          <a class='btn btn-navbar' data-target='.nav-collapse' data-toggle='collapse'>
            <i class='icon-bar'></i>
            <i class='icon-bar'></i>
            <i class='icon-bar'></i>
          </a>
          <a class='brand' href='/'>Alexander Danilenko</a>
          <div class='nav-collapse'>
            <ul class='nav'>
              <li><a href="/">Blog</a></li>
              <li><a href="/contacts/">Contacts</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class='container-fluid'>
      <div class='row-fluid'>
        <div class='span9'>
          <h2><a href="/2012/7/6/rails_timezones/">The Exhaustive Guide to Rails Time Zones</a></h2>
<h3 class='subtitle'>Or what is the difference between Time.zone.now and Time.now</h3>
<p class='post-info'>
  <span class='label'>6 July 2012</span>
  <a class="comments-count" href="/2012/7/6/rails_timezones/#disqus_thread"></a>
</p>
<p>
  Ruby and Rails provide great tools for working with time and time zones.
  But my experience shows that Rails developers often pay little attention to how this magic really works,
  which often results in "ghost" problems that arise in particular configuration and time.
  The main gotcha for developer is that you can use "wrong" methods in development and fairly often
  get valid results. But then you'll face with unexpected problems on production.
</p>
<p>
  Historically Ruby provides two classes to manage time:
  <code class="well"><a href="http://www.ruby-doc.org/core-1.9.3/Time.html">Time</a></code>
and
<code class="well"><a href="http://www.ruby-doc.org/stdlib-1.9.3/libdoc/date/rdoc/DateTime.html">DateTime</a></code>.
  They use different approaches internally, which caused
  <a href="http://stackoverflow.com/questions/1261329/whats-the-difference-between-datetime-and-time-in-ruby">different abilities and performance for them</a>.
  But with Ruby 1.9.3 these differences seem to be vanished and you are free to choose whatever interface you like.
  But that's in Ruby! When it comes to Rails things get a bit more complicated.
</p>
<p>
  Rails gives your ability to configure application time zone. It's as easy as
  <code class="well">Time.zone = 'EST'</code>.
  Setting
  <code class="well">config.time_zone</code>
  in your application.rb will eventually do the same. And this is the right thing to do since we
  don't want to depend on server time zone. But the problem here that now we have 3 (!) different
  time zones in our application: system time, application time and database time. And if you won't
  use correct methods to deal with time all them get mixed up.
</p>
<h2>What's the trick?</h2>
<p>
  Let me give you an example. Let's say you have server in Moscow (GMT+04:00), but most of your
  customers are from US and you use Eastern Standard Time (GMT-05:00) in your application.
  For database Rails by default converts all timestamps to GMT. Let's try calling different methods
  and compare the results.
</p>
<pre class="well"><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
</pre></td>
  <td class="code"><pre><span class="constant">Time</span>.zone = <span class="string"><span class="delimiter">'</span><span class="content">EST</span><span class="delimiter">'</span></span>
<span class="constant">DateTime</span>.now.to_s
<span class="comment"># =&gt; "2012-07-06T13:30:00+04:00"</span>
<span class="constant">Time</span>.now.to_s
<span class="comment"># =&gt; "2012-07-06 13:30:00 +0400"</span>
<span class="constant">Time</span>.zone.now.to_s
<span class="comment"># =&gt; "2012-07-06 04:30:00 -0500"</span></pre></td>
</tr></table></code></pre>
<p>
  You might notice that
  <code class="well">DateTime.now</code>
  and
  <code class="well">Time.now</code>
  both give you the time in system time zone. And it definitely makes sense since these are Ruby
  standard library methods that know nothing about Rails time zone configuration.
  <code class="well">Time.zone.now</code>
  on the contrary is provided by Rails and respects
  <code class="well">Time.zone</code>
  value that we set in Rails.
</p>
<p>
  But you might argue that if we convert all these values to one time zone they will be the same.
  And you are right, if you try to save this time to ActiveRecord model or compare to another
  value you will get expected results. Then what's the problem? Let's try some manipulations with time.
</p>
<pre class="well"><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
</pre></td>
  <td class="code"><pre><span class="constant">Time</span>.zone = <span class="string"><span class="delimiter">'</span><span class="content">EST</span><span class="delimiter">'</span></span>
<span class="constant">Time</span>.now.end_of_day.to_s
<span class="comment"># =&gt; "2012-07-06 23:59:59 +0400"</span>
<span class="constant">Time</span>.zone.now.end_of_day.to_s
<span class="comment"># =&gt; "2012-07-06 23:59:59 -0500"</span></pre></td>
</tr></table></code></pre>
<p>
  Whoops, by using different time zones in initial time we got completely different results.
  That means that before we manipulate time we either need to explicitly convert time to
  required time zone or initially get time in correct time zone. Like this:
</p>
<pre class="well"><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
</pre></td>
  <td class="code"><pre><span class="constant">Time</span>.zone = <span class="string"><span class="delimiter">'</span><span class="content">EST</span><span class="delimiter">'</span></span>
<span class="constant">Time</span>.now.in_time_zone.end_of_day.to_s
<span class="comment"># =&gt; "2012-07-06 23:59:59 -0500"</span>
<span class="constant">Time</span>.zone.now.end_of_day.to_s
<span class="comment"># =&gt; "2012-07-06 23:59:59 -0500"</span></pre></td>
</tr></table></code></pre>
<p>
  Here is another trick. Let's time travel to the next morning. What have we got here?
</p>
<pre class="well"><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
<a href="#n6" name="n6">6</a>
<a href="#n7" name="n7">7</a>
</pre></td>
  <td class="code"><pre><span class="constant">Time</span>.zone = <span class="string"><span class="delimiter">'</span><span class="content">EST</span><span class="delimiter">'</span></span>
<span class="constant">Time</span>.now.to_s
<span class="comment"># =&gt; "2012-07-07 06:30:00 +0400"</span>
<span class="constant">Time</span>.zone.now.to_s
<span class="comment"># =&gt; "2012-07-06 21:30:00 -0500"</span>
<span class="constant">Date</span>.today
<span class="comment"># =&gt; "Fri, 07 Jul 2012"</span></pre></td>
</tr></table></code></pre>
<p>
  But wait, application should still find itself in 6th of July since it uses EST time zone.
  As you might have guessed,
  <code class="well">Date.today</code>
  doesn't know anything about Rails time zone too and uses system time to determine current date.
</p>
<p>
  So, when we know some troubles it might cause, let's find out which methods are safe to use.
</p>
<h2>The Right Way to Go</h2>
<p>
  You might have noticed from given examples that interesting construct
  <code class="well">Time.zone</code>
  that seem to produce correct results.
  So, what is it? Actually above I cheated for simplicity of introduction. It's not Rails responsible
  for adding time zone, but ActiveSupport. It adds
  <code class="well"><a href="http://api.rubyonrails.org/classes/Time.html#method-c-zone-3D">Time.zone=</a></code>
  and
  <code class="well"><a href="http://api.rubyonrails.org/classes/Time.html#method-c-zone">Time.zone</a></code>
  methods to correspondingly set and get current time zone. If you look into source of these methods
  you'll find that the first one finds requested
  <code class="well"><a href="http://api.rubyonrails.org/classes/ActiveSupport/TimeZone.html">ActiveSupport::TimeZone</a></code>
  object and stores it in the current thread, while the second one just fetches if from there.
</p>
<p>
  So, it's
  <code class="well">ActiveSupport::TimeZone</code>
  object where all the magic happens.
  It defines number of methods that makes its API similar to the one of
  <code class="well">Time</code>
  class. That's why from the user point of view it looks like a simple switch from
  <code class="well">Time.now</code>
  to
  <code class="well">Time.zone.now</code>.
  But what actually happens in
  <code class="well">Time.zone.now</code>
  method?
  Turns out it simply grabs current time and converts it do current time zone (which is
  <code class="well">self</code>).
</p>
<pre class="well"><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
<a href="#n3" name="n3">3</a>
<a href="#n4" name="n4">4</a>
<a href="#n5" name="n5">5</a>
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">ActiveSupport::TimeZone</span>
  <span class="keyword">def</span> <span class="function">now</span>
    <span class="constant">Time</span>.now.utc.in_time_zone(<span class="predefined-constant">self</span>)
  <span class="keyword">end</span>
<span class="keyword">end</span></pre></td>
</tr></table></code></pre>
<p>
  And here is the last line of defense,
  <code class="well">in_time_zone</code>
  method. It is added by ActiveSupport to both
  <code class="well"><a href="http://api.rubyonrails.org/classes/Time.html#method-i-in_time_zone">Time</a></code>
  and
  <code class="well"><a href="http://api.rubyonrails.org/classes/DateTime.html#method-i-in_time_zone">DateTime</a></code>
  Ruby standard library methods. In both cases it does the same - converts time to
  <code class="well"><a href="http://api.rubyonrails.org/classes/ActiveSupport/TimeWithZone.html">ActiveSupport::TimeWithZone</a></code>
  object passing specified time zone to it. This class behaves exactly like Ruby
  <code class="well">Time</code>
  object, it even redefines class name. So you can manipulate it as you usually do in Ruby.
</p>
<p>
  Now when we know what's under the hood, I will leave you with brief cheat sheet on correct and incorrect
  methods for dealing with time in Ruby on Rails.
</p>
<h3>Get Current Time</h3>
<pre class="well nolines"><span class="label label-success">Correct</span><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
</pre></td>
  <td class="code"><pre><span class="constant">Time</span>.zone.now</pre></td>
</tr></table></code><span class="label label-warning">Acceptable</span><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
</pre></td>
  <td class="code"><pre><span class="constant">Time</span>.now.in_time_zone
<span class="constant">DateTime</span>.now.in_time_zone</pre></td>
</tr></table></code><span class="label label-important">Wrong</span><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
</pre></td>
  <td class="code"><pre><span class="constant">Time</span>.now
<span class="constant">DateTime</span>.now</pre></td>
</tr></table></code></pre>
<p>
  You should now understand that wrong option will give you time in system time zone, which
  might cause problems. Second (acceptable) option will work fine as it converts time to Rails
  time zone. As we have seen above it is exactly what ActiveSupport is doing internally,
  but there is no need to use it explicitly as there is shorter and more clear option.
</p>
<h3>Get Day (Today, Yesterday, etc.)</h3>
<pre class="well nolines"><span class="label label-success">Correct</span><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
</pre></td>
  <td class="code"><pre><span class="constant">Time</span>.zone.today
<span class="constant">Time</span>.zone.today - <span class="integer">1</span>.day</pre></td>
</tr></table></code><span class="label label-warning">Acceptable</span><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
</pre></td>
  <td class="code"><pre><span class="constant">Date</span>.current
<span class="constant">Date</span>.yesterday</pre></td>
</tr></table></code><span class="label label-important">Wrong</span><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
</pre></td>
  <td class="code"><pre><span class="constant">Date</span>.today</pre></td>
</tr></table></code></pre>
<p>
  ActiveSupport defines
  <code class="well">Date.current</code>
  method that proxies call to
  <code class="well">Time.zone.today</code>
  and it also redefines
  <code class="well">Date.yesterday</code>
  and
  <code class="well">Date.tomorrow</code>
  helpers. But I personally find them quite confusing and easier to be replaced with
  <code class="well">Date.today</code>
  by mistake. So I prefer to use explicit version, but feel free to disagree here.
</p>
<h3>Build Time</h3>
<pre class="well nolines"><span class="label label-success">Correct</span><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
</pre></td>
  <td class="code"><pre><span class="constant">Time</span>.zone.local(<span class="integer">2012</span>, <span class="integer">6</span>, <span class="integer">10</span>, <span class="integer">12</span>, <span class="integer">00</span>)</pre></td>
</tr></table></code><span class="label label-important">Wrong</span><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
<a href="#n2" name="n2">2</a>
</pre></td>
  <td class="code"><pre><span class="constant">Time</span>.new(<span class="integer">2012</span>, <span class="integer">6</span>, <span class="integer">10</span>, <span class="integer">12</span>, <span class="integer">00</span>)
<span class="constant">DateTime</span>.new(<span class="integer">2012</span>, <span class="integer">6</span>, <span class="integer">10</span>, <span class="integer">12</span>, <span class="integer">00</span>)</pre></td>
</tr></table></code></pre>
<p>
  I believe this one doesn't need any comments as Ruby classes are simply not aware of the time zone in use.
</p>
<h3>Time From Timestamp</h3>
<pre class="well nolines"><span class="label label-success">Correct</span><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
</pre></td>
  <td class="code"><pre><span class="constant">Time</span>.zone.at(timestamp)</pre></td>
</tr></table></code><span class="label label-warning">Acceptable</span><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
</pre></td>
  <td class="code"><pre><span class="constant">Time</span>.at(timestamp).in_time_zone</pre></td>
</tr></table></code><span class="label label-important">Wrong</span><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
</pre></td>
  <td class="code"><pre><span class="constant">Time</span>.at(timestamp)</pre></td>
</tr></table></code></pre>
<h3>Parse Time (Simple)</h3>
<pre class="well nolines"><span class="label label-success">Correct</span><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
</pre></td>
  <td class="code"><pre><span class="constant">Time</span>.zone.parse(str)</pre></td>
</tr></table></code><span class="label label-important">Wrong</span><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
</pre></td>
  <td class="code"><pre><span class="constant">Time</span>.parse(str)</pre></td>
</tr></table></code></pre>
<h3>Parse Time (With Explicit Format)</h3>
<pre class="well nolines"><span class="label label-warning">Acceptable</span><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
</pre></td>
  <td class="code"><pre><span class="constant">DateTime</span>.strptime(str, <span class="string"><span class="delimiter">"</span><span class="content">%Y-%m-%d %H:%M %Z</span><span class="delimiter">"</span></span>).in_time_zone</pre></td>
</tr></table></code><span class="label label-important">Wrong</span><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
</pre></td>
  <td class="code"><pre><span class="constant">DateTime</span>.strptime(str, <span class="string"><span class="delimiter">"</span><span class="content">%Y-%m-%d %H:%M</span><span class="delimiter">"</span></span>)</pre></td>
</tr></table></code></pre>
<p>
  Here I have to make one important note. Correct option will give valid results only when time
  string (and format of course) explicitly include time zone (note %Z in format string).
  But there are cases when you need to parse time without specified time zone. In this case you
  usually need to treat this time in current time zone. Unfortunately ActiveSupport doesn't
  provide convenient means for this. To fill this gap you can use my micro gem
  <a href="https://github.com/doz/time_zone_ext">TimeZoneExt</a>
  that allows you to parse time with or without explicitly specified time zone.
  This adds one more correct option.
</p>
<pre class="well nolines"><span class="label label-success">Correct</span><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
</pre></td>
  <td class="code"><pre><span class="constant">Time</span>.zone.strptime(str, <span class="string"><span class="delimiter">"</span><span class="content">%Y-%m-%d %H:%M</span><span class="delimiter">"</span></span>)</pre></td>
</tr></table></code></pre>
<h3>Get Time For Date</h3>
<pre class="well nolines"><span class="label label-success">Correct</span><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
</pre></td>
  <td class="code"><pre>date.beginning_of_day</pre></td>
</tr></table></code><span class="label label-warning">Acceptable</span><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
</pre></td>
  <td class="code"><pre>date.to_time_in_current_zone</pre></td>
</tr></table></code><span class="label label-important">Wrong</span><code class="language-ruby"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre><a href="#n1" name="n1">1</a>
</pre></td>
  <td class="code"><pre>date.to_time</pre></td>
</tr></table></code></pre>
<p>
  Again, default
  <code class="well">to_time</code>
  method provided by Ruby knows nothing about time zone in use. So you should use one of the
  methods defined in ActiveSupport. I personally find
  <code class="well">beginning_of_day</code>
  more explicit, although
  <code class="well">to_time_in_current_zone</code>
  gives the same result.
</p>
<h2>Conclusion</h2>
<p>
  There is no rocket science in dealing with time in Rails. But it's a good idea to understand it once
  and always keep in mind that when you build time or date object you should respect current time zone.
  In most cases it simply means to use
  <code class="well">Time.zone</code>
  instead of
  <code class="well">Time</code>,
  <code class="well">Date</code>
  or
  <code class="well">DateTime</code>.
</p>
<p>
  I do not cover dealing with other than default time zones in Rails. This post has another purpose.
  But it is possible and quite easy to do. And now you have references to classes to look into.
</p>
<br>
<p>
  </p><center>
    <i>
      For more high-quality posts check out
      <a href="http://www.toptal.com/blog">blog at toptal.com</a>
    </i>
  </center>
        </div>
        <div class='span3'>
          <div class='well sidebar-about'>
            <div class='nav'>
              <div class='nav-header'>About Author</div>
            </div>
            <img alt='Alexander Danilenko' height='80' src='/images/danilenko.png' width='80' />
            <p>
              Alexander is CTO at
              <a href="http://www.toptal.com">Toptal</a>
              with more than 10 years experience in professional software development
              passionately working with Ruby on Rails since 2007.
            </p>
          </div>
          <div class='well sidebar-nav'>
            <ul class='nav nav-list'>
              <li class='nav-header'>Blog Posts</li>
              <li><a href="/2012/7/6/rails_timezones/">The Exhaustive Guide to Rails Time Zones</a></li>
              <li class='toptal'>
                For more high-quality posts check out
                <a href='http://www.toptal.com/blog'>blog at toptal.com</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <hr />
      <footer>
        <p class='footer-social'>
          <a title="Contacts" href="/contacts/"><i class="icon-envelope"></i></a>
          <a title="Linkedin" href="http://www.linkedin.com/pub/alexander-danilenko/33/442/552"><i class="icon-linkedin"></i></a>
          <a title="Facebook" href="https://www.facebook.com/alexander.danilenko"><i class="icon-facebook"></i></a>
          <a title="github" href="https://github.com/doz"><i class="icon-github"></i></a>
        </p>
        <p>&copy; 2012-2014 Alexander Danilenko</p>
      </footer>
    </div>
    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'danilenko'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
  </body>
</html>
